#!/usr/bin/env bash
shopt -s nullglob

# Check subcommand
if [ "${1}" == 'type' ] || [ "${1}" == 'copy' ]; then
  subcommand="${1}"
else
  echo "Usage: ${0} [copy|type] [DATAFILES*]"
  echo "Quickly look up and input emoji and/or emoticons/kaomoji" \
    "on your GNU/Linux desktop via pop-up menu."
  exit 1
fi
shift

# Determine config files
scriptdir="$( cd "$( dirname "$( readlink -f "${BASH_SOURCE[0]}" )" )" && pwd )"
if [ -f "${HOME}/.config/splatmoji/splatmoji.config" ]; then
  conffile="${HOME}/.config/splatmoji/splatmoji.config"
else
  conffile="${scriptdir}/splatmoji.config"
fi

if [ $# -eq 0 ]; then
  datafiles=("${scriptdir}/data/*")
else
  datafiles="${@:1}"
fi
datafiles_list=$(IFS=$'\n'; echo "${datafiles[*]}")

# Read config
declare -A config
while IFS='' read -r line; do
  if [[ -z "${line}" ]] || [ "${line:0:1}" == '#' ]; then
    continue
  fi
  key=$(echo "${line}" | cut -d '=' -f 1)
  val=$(echo "${line}" | cut -d '=' -f 2)
  config["${key}"]="${val}"
done < "${conffile}"

# Prompt user for selection
selection=$(cat ${datafiles_list} | eval ${config[rofi_command]})
moji=$(cut -f 1 <<< "$selection")

# Results to clipboard or selected x window
if [ "${subcommand}" == 'type' ]; then
  ${config[xdotool_command]} "${moji}"
else
  echo -n "${moji}" | ${config[xsel_command]}
fi
